#!/bin/bash

# Pre-commit hook to catch bugs before they're committed
set -e

echo "üîç Running pre-commit checks..."

# 1. Format code
echo "üìù Formatting code..."
mix format --check-formatted

# 2. Run critical tests
echo "üß™ Running tests..."
mix test --warnings-as-errors

# 3. Check for security issues
echo "üîí Security check..."
mix sobelow --exit

# 4. Check for duplicate LiveView IDs (critical for DOM patching)
echo "üîÑ Checking for LiveView issues..."
if mix test 2>&1 | grep -q "Duplicate id found"; then
    echo "‚ùå Duplicate LiveView IDs detected! This causes DOM patching bugs."
    echo "Fix duplicate IDs before committing."
    exit 1
fi

echo "‚úÖ All pre-commit checks passed!"